<html>
<head>
  <title>Real-Time Emotion Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
  <h1>Emotion Detection</h1>
  <video id="webcam" autoplay></video>
  <canvas id="output"></canvas>
  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('output');
    const context = canvas.getContext('2d');

    // Load ONNX model with ONNX Runtime Web
    async function loadModel() {
      try {
        const session = await ort.InferenceSession.create('path-to-your-onnx-model/model.onnx');
        console.log('Model loaded:', session);
        return session;
      } catch (error) {
        console.error('Error loading model:', error);
        throw error;  // Re-throw to propagate the error
      }
    }


    // Setup the webcam
    async function setupWebcam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        console.log('Webcam initialized');
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      } catch (error) {
        console.error('Error setting up webcam:', error);
        throw error;  // Re-throw to propagate the error
      }
    }

    // Run emotion detection using the model
    async function detectEmotion(session) {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const input = new ort.Tensor('float32', new Float32Array(imageData.data), [1, 3, 80, 80]);

      // Run the model with the input tensor
      const results = await session.run({ input: input });
      const outputTensor = results[session.outputNames[0]];

      // Handle the output here (e.g., display the detected emotion)
      console.log(outputTensor);
    }

    async function run() {
    try {
      const session = await loadModel();  // Load the ONNX model
      console.log('Model loaded successfully');
      
      await setupWebcam();  // Setup webcam for video streaming
      console.log('Webcam setup complete');
      
      setInterval(() => {
        try {
          detectEmotion(session);  // Run the emotion detection function
        } catch (error) {
          console.error('Error during emotion detection:', error);
        }
      }, 100);  // Run detection every 100ms
      
    } catch (error) {
      console.error('Error in main loop:', error);
    }
  }

    run();
  </script>
</body>
</html>
